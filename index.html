<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق التواصل</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 500px; margin: auto; }
        input, button, textarea { width: 100%; padding: 10px; margin: 5px 0; }
        .post { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="container">
        <h2>تسجيل الدخول / التسجيل</h2>
        <input type="email" id="email" placeholder="البريد الإلكتروني">
        <input type="password" id="password" placeholder="كلمة المرور">
        <button onclick="register()">تسجيل</button>
        <button onclick="login()">دخول</button>
        
        <h2>إضافة منشور</h2>
        <textarea id="postContent" placeholder="اكتب منشورك هنا"></textarea>
        <button onclick="addPost()">نشر</button>
        
        <h2>المنشورات</h2>
        <div id="posts"></div>
    </div>

    <script>
        // استخدام خادم وسيط لتجاوز CORS
        const proxyUrl = "https://cors-anywhere.herokuapp.com/";
        const apiUrl = "https://cloud.appwrite.io/v1";

        const client = new Appwrite.Client();
        client.setEndpoint(proxyUrl + apiUrl).setProject('67a7b2e0003038b4f3fd');

        const account = new Appwrite.Account(client);
        const databases = new Appwrite.Databases(client);

        let databaseId = null;
        let postsCollectionId = null;

        async function setupDatabase() {
            try {
                const dbs = await databases.list();
                let db = dbs.databases.find(d => d.name === "SocialApp");
                if (!db) {
                    db = await databases.create('unique()', 'SocialApp');
                }
                databaseId = db.$id;

                const collections = await databases.listCollections(databaseId);
                let postsCollection = collections.collections.find(c => c.name === "Posts");
                if (!postsCollection) {
                    postsCollection = await databases.createCollection(databaseId, 'unique()', 'Posts');
                    await databases.createStringAttribute(databaseId, postsCollection.$id, 'content', 500, true);
                }
                postsCollectionId = postsCollection.$id;
                console.log("تم تهيئة قاعدة البيانات بنجاح!");

            } catch (error) {
                console.error("خطأ في إعداد قاعدة البيانات:", error);
            }
        }

        async function register() {
            try {
                await account.create('unique()', document.getElementById('email').value, document.getElementById('password').value);
                alert("تم التسجيل بنجاح!");
            } catch (error) {
                alert("خطأ في التسجيل: " + error.message);
            }
        }

        async function login() {
            try {
                await account.createEmailSession(document.getElementById('email').value, document.getElementById('password').value);
                alert("تم تسجيل الدخول بنجاح!");
                getPosts();
            } catch (error) {
                alert("خطأ في تسجيل الدخول: " + error.message);
            }
        }

        async function addPost() {
            if (!databaseId || !postsCollectionId) {
                alert("لم يتم تهيئة قاعدة البيانات بعد.");
                return;
            }

            try {
                await databases.createDocument(databaseId, postsCollectionId, 'unique()', { content: document.getElementById('postContent').value });
                alert("تم نشر المنشور!");
                getPosts();
            } catch (error) {
                alert("خطأ في نشر المنشور: " + error.message);
            }
        }

        async function getPosts() {
            if (!databaseId || !postsCollectionId) {
                alert("لم يتم تهيئة قاعدة البيانات بعد.");
                return;
            }

            try {
                const response = await databases.listDocuments(databaseId, postsCollectionId);
                document.getElementById('posts').innerHTML = response.documents.map(post => `
                    <div class="post">
                        <p>${post.content}</p>
                        <button onclick="likePost('${post.$id}')">إعجاب</button>
                        <button onclick="addComment('${post.$id}')">تعليق</button>
                    </div>
                `).join('');
            } catch (error) {
                alert("خطأ في جلب المنشورات: " + error.message);
            }
        }

        async function likePost(postId) {
            alert("تم تسجيل الإعجاب بالمنشور " + postId);
        }

        async function addComment(postId) {
            const comment = prompt("اكتب تعليقك:");
            if (comment) alert("تمت إضافة تعليقك على المنشور " + postId);
        }

        setupDatabase();
        getPosts();
    </script>

</body>
</html>
