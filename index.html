<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق التواصل باستخدام Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        .container { max-width: 500px; margin: auto; background: #f9f9f9; padding: 20px; border-radius: 8px; }
        input, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
        .post { border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #fff; border-radius: 5px; text-align: left; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h2>تسجيل الدخول / التسجيل</h2>
        <input type="email" id="email" placeholder="البريد الإلكتروني">
        <input type="password" id="password" placeholder="كلمة المرور">
        <button onclick="register()">تسجيل</button>
        <button onclick="login()">دخول</button>
        <button onclick="logout()" class="hidden" id="logoutBtn">تسجيل الخروج</button>

        <h2>إضافة منشور</h2>
        <textarea id="postContent" placeholder="اكتب منشورك هنا"></textarea>
        <button onclick="addPost()">نشر</button>

        <h2>المنشورات</h2>
        <div id="posts"></div>
    </div>

    <script>
        // **تهيئة Supabase**
        const SUPABASE_URL = "https://xvftfiwrnjbgyvfe.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5c...";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // **تسجيل مستخدم جديد**
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabase.auth.signUp({ email, password });

            if (error) {
                alert("❌ خطأ في التسجيل: " + error.message);
            } else {
                alert("✅ تم التسجيل بنجاح! تحقق من بريدك الإلكتروني.");
            }
        }

        // **تسجيل الدخول**
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                alert("❌ خطأ في تسجيل الدخول: " + error.message);
            } else {
                alert("✅ تم تسجيل الدخول بنجاح!");
                document.getElementById("logoutBtn").classList.remove("hidden");
                getUser();
                getPosts();
            }
        }

        // **جلب بيانات المستخدم بعد تسجيل الدخول**
        async function getUser() {
            const { data, error } = await supabase.auth.getUser();
            if (!error && data.user) {
                currentUser = data.user;
            } else {
                console.error("فشل في جلب المستخدم:", error);
            }
        }

        // **تسجيل الخروج**
        async function logout() {
            await supabase.auth.signOut();
            alert("🚪 تم تسجيل الخروج!");
            document.getElementById("logoutBtn").classList.add("hidden");
            currentUser = null;
        }

        // **إضافة منشور**
        async function addPost() {
            if (!currentUser) {
                alert("⚠️ يجب تسجيل الدخول أولاً!");
                return;
            }

            const content = document.getElementById('postContent').value;

            const { data, error } = await supabase
                .from("posts")
                .insert([{ content, user_id: currentUser.id }]);

            if (error) {
                alert("❌ خطأ في نشر المنشور: " + error.message);
            } else {
                alert("✅ تم نشر المنشور!");
                getPosts();
            }
        }

        // **جلب المنشورات مع أسماء المستخدمين**
        async function getPosts() {
            const { data, error } = await supabase
                .from("posts")
                .select("id, content, user_id, users(username)")
                .order("created_at", { ascending: false });

            if (error) {
                alert("❌ خطأ في تحميل المنشورات: " + error.message);
            } else {
                document.getElementById('posts').innerHTML = data.map(post => `
                    <div class="post">
                        <p><strong>${post.users.username}</strong>: ${post.content}</p>
                        <button onclick="likePost(${post.id})">👍 إعجاب</button>
                        <button onclick="addComment(${post.id})">💬 تعليق</button>
                        <div id="comments-${post.id}"></div>
                    </div>
                `).join('');
            }
        }

        // **إضافة إعجاب للمنشور**
        async function likePost(postId) {
            if (!currentUser) {
                alert("⚠️ يجب تسجيل الدخول أولاً!");
                return;
            }

            const { error } = await supabase.from("likes").insert([{ post_id: postId, user_id: currentUser.id }]);
            if (error) {
                alert("❌ خطأ في تسجيل الإعجاب: " + error.message);
            } else {
                alert("👍 تم تسجيل إعجابك!");
            }
        }

        // **إضافة تعليق**
        async function addComment(postId) {
            if (!currentUser) {
                alert("⚠️ يجب تسجيل الدخول أولاً!");
                return;
            }

            const comment = prompt("💬 اكتب تعليقك:");
            if (!comment) return;

            const { error } = await supabase.from("comments").insert([{ post_id: postId, user_id: currentUser.id, comment_text: comment }]);
            if (error) {
                alert("❌ خطأ في إضافة التعليق: " + error.message);
            } else {
                alert("✅ تمت إضافة تعليقك!");
                loadComments(postId);
            }
        }

        // **تحميل التعليقات لمنشور معين**
        async function loadComments(postId) {
            const { data, error } = await supabase
                .from("comments")
                .select("comment_text, users(username)")
                .eq("post_id", postId);

            if (!error) {
                document.getElementById(`comments-${postId}`).innerHTML = data.map(comment => `
                    <p><strong>${comment.users.username}</strong>: ${comment.comment_text}</p>
                `).join('');
            }
        }

        getUser();
        getPosts();
    </script>

</body>
</html>
