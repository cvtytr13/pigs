<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; background-color: #f0f2f5; }
        .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        input, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
        .post { border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #fff; border-radius: 5px; text-align: left; }
        .hidden { display: none; }
        .error-message { color: red; font-weight: bold; }
        .status-message { color: green; font-weight: bold; margin-bottom: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 10px; }
        .button-group button { flex: 1; }
        .post-actions { display: flex; gap: 10px; margin-top: 10px; }
        .post-actions button { flex: 1; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„</h2>
        <p id="statusMessage" class="status-message">ğŸ”ƒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</p>
        <p id="errorMessage" class="error-message"></p>

        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h2>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <div class="button-group">
            <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
            <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <button onclick="logout()" class="hidden" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

        <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ±</h2>
        <textarea id="postContent" placeholder="Ø§ÙƒØªØ¨ Ù…Ù†Ø´ÙˆØ±Ùƒ Ù‡Ù†Ø§"></textarea>
        <button onclick="addPost()">Ù†Ø´Ø±</button>

        <h2>Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h2>
        <div id="posts"></div>
    </div>

    <script>
        // **ØªÙ‡ÙŠØ¦Ø© Supabase**
        const SUPABASE_URL = "https://xvftfivwrnjbgyvfeimz.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2ZnRmaXZ3cm5qYmd5dmZlaW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzODY3MTEsImV4cCI6MjA1Mzk2MjcxMX0.NAgwIlw-98m8y5EW2dlXEcc-rFKI-TYyUpeEj5_CJKs";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**
        async function checkConnection() {
            const statusMessage = document.getElementById('statusMessage');
            try {
                const { data, error } = await supabase.from('posts').select('*').limit(1);
                if (error) throw error;
                statusMessage.innerText = "âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ø¬Ø­!";
            } catch (error) {
                statusMessage.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!";
                console.error(error);
            }
        }

        // **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…**
        async function checkUser() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (user) {
                document.getElementById("logoutBtn").classList.remove("hidden");
                getPosts();
            }
        }

        // **ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯**
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) {
                document.getElementById('errorMessage').innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message;
            } else {
                alert("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
            }
        }

        // **ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„**
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                document.getElementById('errorMessage').innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message;
            } else {
                alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
                currentUser = data.user;
                document.getElementById("logoutBtn").classList.remove("hidden");
                getPosts();
            }
        }

        // **ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬**
        async function logout() {
            await supabase.auth.signOut();
            alert("ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬!");
            document.getElementById("logoutBtn").classList.add("hidden");
            currentUser = null;
        }

        // **Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ±**
        async function addPost() {
            if (!currentUser) {
                document.getElementById('errorMessage').innerText = "âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!";
                return;
            }

            const content = document.getElementById('postContent').value;

            const { error } = await supabase
                .from("posts")
                .insert([{ content, user_id: currentUser.id }]);

            if (error) {
                document.getElementById('errorMessage').innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±: " + error.message;
            } else {
                alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±!");
                getPosts();
            }
        }

        // **Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†**
        async function getPosts() {
            const { data, error } = await supabase
                .from("posts")
                .select("id, content, user_id, users(username)")
                .order("created_at", { ascending: false });

            if (error) {
                document.getElementById('errorMessage').innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª: " + error.message;
            } else {
                document.getElementById('posts').innerHTML = data.map(post => `
                    <div class="post">
                        <p><strong>${post.users ? post.users.username : "Ù…Ø¬Ù‡ÙˆÙ„"}</strong>: ${post.content}</p>
                        <div class="post-actions">
                            <button onclick="likePost(${post.id})">ğŸ‘ Ø¥Ø¹Ø¬Ø§Ø¨</button>
                            <button onclick="addComment(${post.id})">ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚</button>
                        </div>
                        <div id="comments-${post.id}"></div>
                    </div>
                `).join('');
            }
        }

        // **Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¬Ø§Ø¨ Ù„Ù„Ù…Ù†Ø´ÙˆØ±**
        async function likePost(postId) {
            if (!currentUser) {
                document.getElementById('errorMessage').innerText = "âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!";
                return;
            }

            const { error } = await supabase.from("likes").insert([{ post_id: postId, user_id: currentUser.id }]);
            if (error) {
                document.getElementById('errorMessage').innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨: " + error.message;
            } else {
                alert("ğŸ‘ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¹Ø¬Ø§Ø¨Ùƒ!");
            }
        }

        // **ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„ÙƒÙ„ Ù…Ù†Ø´ÙˆØ±**
        async function getComments(postId) {
            const { data, error } = await supabase
                .from("comments")
                .select("content, users(username)")
                .eq("post_id", postId);

            if (!error) {
                document.getElementById(`comments-${postId}`).innerHTML = data.map(comment => `
                    <p><strong>${comment.users.username}</strong>: ${comment.content}</p>
                `).join('');
            }
        }

        // **ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©**
        document.addEventListener("DOMContentLoaded", () => {
            checkConnection();
            checkUser();
        });
    </script>

</body>
</html>
